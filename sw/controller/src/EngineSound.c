#include "EngineSound.h"
#include "../inc/Timer0A.h"
#include "DAC.h"
#include "../inc/tm4c123gh6pm.h"
#include "./inc/random.h"

// #define tsizel2 (256)
// const static uint16_t generic_wave_table[256] = {
//     65535, 65329, 64718, 63713, 62337, 60619, 58594, 56306, 53802, 51130, 48345, 45498, 42641, 39826, 37097, 34498, 32064, 29825, 27804, 26018, 24474, 23173, 22110, 21272, 20641, 20194, 19905, 19744, 19680, 19681, 19717, 19758, 19777, 19751, 19660, 19489, 19227, 18870, 18417, 17871, 17241, 16539, 15778, 14978, 14155, 13329, 12518, 11742, 11015, 10352, 9765, 9260, 8844, 8518, 8278, 8121, 8036, 8015, 8043, 8107, 8191, 8281, 8361, 8417, 8439, 8414, 8337, 8201, 8005, 7749, 7436, 7073, 6667, 6229, 5769, 5300, 4835, 4386, 3964, 3580, 3243, 2960, 2735, 2571, 2468, 2422, 2431, 2485, 2578, 2699, 2836, 2980, 3119, 3242, 3339, 3402, 3424, 3400, 3329, 3209, 3042, 2832, 2586, 2310, 2014, 1706, 1399, 1101, 824, 576, 365, 199, 81, 14, 0, 36, 119, 245, 406, 593, 797, 1009, 1219, 1415, 1590, 1735, 1844, 1911, 1934, 1911, 1844, 1735, 1590, 1415, 1219, 1009, 797, 593, 406, 245, 119, 36, 0, 14, 81, 199, 365, 576, 824, 1101, 1399, 1706, 2014, 2310, 2586, 2832, 3042, 3209, 3329, 3400, 3424, 3402, 3339, 3242, 3119, 2980, 2836, 2699, 2578, 2485, 2431, 2422, 2468, 2571, 2735, 2960, 3243, 3580, 3964, 4386, 4835, 5300, 5769, 6229, 6667, 7073, 7436, 7749, 8005, 8201, 8337, 8414, 8439, 8417, 8361, 8281, 8191, 8107, 8043, 8015, 8036, 8121, 8278, 8518, 8844, 9260, 9765, 10352, 11015, 11742, 12518, 13329, 14155, 14978, 15778, 16539, 17241, 17871, 18417, 18870, 19227, 19489, 19660, 19751, 19777, 19758, 19717, 19681, 19680, 19744, 19905, 20194, 20641, 21272, 22110, 23173, 24474, 26018, 27804, 29825, 32064, 34498, 37097, 39826, 42641, 45498, 48345, 51130, 53802, 56306, 58594, 60619, 62337, 63713, 64718, 65329
// };

// #define tsizel2 (512)
// const static uint16_t generic_wave_table[512] = {
//     65535, 46926, 23173, 19772, 15778, 8670, 8417, 6001, 2468, 3375, 1706, 72, 1844, 694, 576, 3275, 2578, 4171, 8201, 8019, 12518, 19370, 20194, 35779, 62337, 57481, 29825, 19702, 18417, 10675, 8107, 7599, 3243, 2908, 2832, 133, 1219, 1506, 14, 2451, 3119, 2840, 7073, 8236, 9765, 17566, 19681, 26881, 53802, 64263, 39826, 20931, 19660, 13741, 8121, 8383, 4835, 2453, 3400, 960, 406, 1928, 245, 1248, 3424, 2420, 5300, 8433, 8278, 14568, 19751, 21663, 42641, 65074, 51130, 25215, 19717, 16898, 9260, 8323, 6667, 2645, 3242, 2164, 0, 1667, 1009, 276, 3042, 2766, 3580, 7884, 8043, 11371, 18870, 19810, 32064, 59642, 60619, 33258, 19905, 19061, 11742, 8024, 8005, 3767, 2699, 3131, 365, 903, 1735, 11, 2014, 3294, 2571, 6452, 8361, 9041, 16539, 19739, 24474, 49749, 65329, 44068, 22110, 19771, 14978, 8387, 8439, 5535, 2422, 3418, 1399, 177, 1911, 497, 824, 3371, 2485, 4608, 8337, 8070, 13329, 19585, 20641, 38448, 63713, 55078, 27804, 19674, 17871, 10048, 8191, 7261, 2960, 3051, 2586, 41, 1415, 1319, 81, 2713, 2980, 3094, 7436, 8147, 10352, 18155, 19680, 28786, 56306, 63070, 37097, 20396, 19489, 12920, 8036, 8276, 4386, 2527, 3329, 696, 593, 1883, 119, 1552, 3402, 2438, 5769, 8433, 8518, 15382, 19777, 22612, 45498, 65483, 48345, 23793, 19758, 16165, 8844, 8393, 6229, 2512, 3339, 1861, 36, 1794, 797, 466, 3209, 2635, 3964, 8111, 8015, 12125, 19227, 20031, 34498, 61518, 58594, 30918, 19744, 18655, 11015, 8072, 7749, 3405, 2836, 2942, 199, 1115, 1590, 0, 2310, 3183, 2735, 6875, 8281, 9502, 17241, 19697, 26018, 52484, 64718, 41226, 21272, 19715, 14155, 8190, 8414, 5067, 2431, 3418, 1101, 322, 1934, 322, 1101, 3418, 2431, 5067, 8414, 8190, 14155, 19715, 21272, 41226, 64718, 52484, 26018, 19697, 17241, 9502, 8281, 6875, 2735, 3183, 2310, 0, 1590, 1115, 199, 2942, 2836, 3405, 7749, 8072, 11015, 18655, 19744, 30918, 58594, 61518, 34498, 20031, 19227, 12125, 8015, 8111, 3964, 2635, 3209, 466, 797, 1794, 36, 1861, 3339, 2512, 6229, 8393, 8844, 16165, 19758, 23793, 48345, 65483, 45498, 22612, 19777, 15382, 8518, 8433, 5769, 2438, 3402, 1552, 119, 1883, 593, 696, 3329, 2527, 4386, 8276, 8036, 12920, 19489, 20396, 37097, 63070, 56306, 28786, 19680, 18155, 10352, 8147, 7436, 3094, 2980, 2713, 81, 1319, 1415, 41, 2586, 3051, 2960, 7261, 8191, 10048, 17871, 19674, 27804, 55078, 63713, 38448, 20641, 19585, 13329, 8070, 8337, 4608, 2485, 3371, 824, 497, 1911, 177, 1399, 3418, 2422, 5535, 8439, 8387, 14978, 19771, 22110, 44068, 65329, 49749, 24474, 19739, 16539, 9041, 8361, 6452, 2571, 3294, 2014, 11, 1735, 903, 365, 3131, 2699, 3767, 8005, 8024, 11742, 19061, 19905, 33258, 60619, 59642, 32064, 19810, 18870, 11371, 8043, 7884, 3580, 2766, 3042, 276, 1009, 1667, 0, 2164, 3242, 2645, 6667, 8323, 9260, 16898, 19717, 25215, 51130, 65074, 42641, 21663, 19751, 14568, 8278, 8433, 5300, 2420, 3424, 1248, 245, 1928, 406, 960, 3400, 2453, 4835, 8383, 8121, 13741, 19660, 20931, 39826, 64263, 53802, 26881, 19681, 17566, 9765, 8236, 7073, 2840, 3119, 2451, 14, 1506, 1219, 133, 2832, 2908, 3243, 7599, 8107, 10675, 18417, 19702, 29825, 57481, 62337, 35779, 20194, 19370, 12518, 8019, 8201, 4171, 2578, 3275, 576, 694, 1844, 72, 1706, 3375, 2468, 6001, 8417, 8670, 15778, 19772, 23173, 46926
// };

#define tsizel2 (1024)
const static uint16_t generic_wave_table[1024] = {
    65535, 65483, 65329, 65074, 64718, 64263, 63713, 63070, 62337, 61518, 60619, 59642, 58594, 57481, 56306, 55078, 53802, 52484, 51130, 49749, 48345, 46926, 45498, 44068, 42641, 41226, 39826, 38448, 37097, 35779, 34498, 33258, 32064, 30918, 29825, 28786, 27804, 26881, 26018, 25215, 24474, 23793, 23173, 22612, 22110, 21663, 21272, 20931, 20641, 20396, 20194, 20031, 19905, 19810, 19744, 19702, 19680, 19674, 19681, 19697, 19717, 19739, 19758, 19772, 19777, 19771, 19751, 19715, 19660, 19585, 19489, 19370, 19227, 19061, 18870, 18655, 18417, 18155, 17871, 17566, 17241, 16898, 16539, 16165, 15778, 15382, 14978, 14568, 14155, 13741, 13329, 12920, 12518, 12125, 11742, 11371, 11015, 10675, 10352, 10048, 9765, 9502, 9260, 9041, 8844, 8670, 8518, 8387, 8278, 8190, 8121, 8070, 8036, 8019, 8015, 8024, 8043, 8072, 8107, 8147, 8191, 8236, 8281, 8323, 8361, 8393, 8417, 8433, 8439, 8433, 8414, 8383, 8337, 8276, 8201, 8111, 8005, 7884, 7749, 7599, 7436, 7261, 7073, 6875, 6667, 6452, 6229, 6001, 5769, 5535, 5300, 5067, 4835, 4608, 4386, 4171, 3964, 3767, 3580, 3405, 3243, 3094, 2960, 2840, 2735, 2645, 2571, 2512, 2468, 2438, 2422, 2420, 2431, 2453, 2485, 2527, 2578, 2635, 2699, 2766, 2836, 2908, 2980, 3051, 3119, 3183, 3242, 3294, 3339, 3375, 3402, 3418, 3424, 3418, 3400, 3371, 3329, 3275, 3209, 3131, 3042, 2942, 2832, 2713, 2586, 2451, 2310, 2164, 2014, 1861, 1706, 1552, 1399, 1248, 1101, 960, 824, 696, 576, 466, 365, 276, 199, 133, 81, 41, 14, 0, 0, 11, 36, 72, 119, 177, 245, 322, 406, 497, 593, 694, 797, 903, 1009, 1115, 1219, 1319, 1415, 1506, 1590, 1667, 1735, 1794, 1844, 1883, 1911, 1928, 1934, 1928, 1911, 1883, 1844, 1794, 1735, 1667, 1590, 1506, 1415, 1319, 1219, 1115, 1009, 903, 797, 694, 593, 497, 406, 322, 245, 177, 119, 72, 36, 11, 0, 0, 14, 41, 81, 133, 199, 276, 365, 466, 576, 696, 824, 960, 1101, 1248, 1399, 1552, 1706, 1861, 2014, 2164, 2310, 2451, 2586, 2713, 2832, 2942, 3042, 3131, 3209, 3275, 3329, 3371, 3400, 3418, 3424, 3418, 3402, 3375, 3339, 3294, 3242, 3183, 3119, 3051, 2980, 2908, 2836, 2766, 2699, 2635, 2578, 2527, 2485, 2453, 2431, 2420, 2422, 2438, 2468, 2512, 2571, 2645, 2735, 2840, 2960, 3094, 3243, 3405, 3580, 3767, 3964, 4171, 4386, 4608, 4835, 5067, 5300, 5535, 5769, 6001, 6229, 6452, 6667, 6875, 7073, 7261, 7436, 7599, 7749, 7884, 8005, 8111, 8201, 8276, 8337, 8383, 8414, 8433, 8439, 8433, 8417, 8393, 8361, 8323, 8281, 8236, 8191, 8147, 8107, 8072, 8043, 8024, 8015, 8019, 8036, 8070, 8121, 8190, 8278, 8387, 8518, 8670, 8844, 9041, 9260, 9502, 9765, 10048, 10352, 10675, 11015, 11371, 11742, 12125, 12518, 12920, 13329, 13741, 14155, 14568, 14978, 15382, 15778, 16165, 16539, 16898, 17241, 17566, 17871, 18155, 18417, 18655, 18870, 19061, 19227, 19370, 19489, 19585, 19660, 19715, 19751, 19771, 19777, 19772, 19758, 19739, 19717, 19697, 19681, 19674, 19680, 19702, 19744, 19810, 19905, 20031, 20194, 20396, 20641, 20931, 21272, 21663, 22110, 22612, 23173, 23793, 24474, 25215, 26018, 26881, 27804, 28786, 29825, 30918, 32064, 33258, 34498, 35779, 37097, 38448, 39826, 41226, 42641, 44068, 45498, 46926, 48345, 49749, 51130, 52484, 53802, 55078, 56306, 57481, 58594, 59642, 60619, 61518, 62337, 63070, 63713, 64263, 64718, 65074, 65329, 65483, 65535, 65483, 65329, 65074, 64718, 64263, 63713, 63070, 62337, 61518, 60619, 59642, 58594, 57481, 56306, 55078, 53802, 52484, 51130, 49749, 48345, 46926, 45498, 44068, 42641, 41226, 39826, 38448, 37097, 35779, 34498, 33258, 32064, 30918, 29825, 28786, 27804, 26881, 26018, 25215, 24474, 23793, 23173, 22612, 22110, 21663, 21272, 20931, 20641, 20396, 20194, 20031, 19905, 19810, 19744, 19702, 19680, 19674, 19681, 19697, 19717, 19739, 19758, 19772, 19777, 19771, 19751, 19715, 19660, 19585, 19489, 19370, 19227, 19061, 18870, 18655, 18417, 18155, 17871, 17566, 17241, 16898, 16539, 16165, 15778, 15382, 14978, 14568, 14155, 13741, 13329, 12920, 12518, 12125, 11742, 11371, 11015, 10675, 10352, 10048, 9765, 9502, 9260, 9041, 8844, 8670, 8518, 8387, 8278, 8190, 8121, 8070, 8036, 8019, 8015, 8024, 8043, 8072, 8107, 8147, 8191, 8236, 8281, 8323, 8361, 8393, 8417, 8433, 8439, 8433, 8414, 8383, 8337, 8276, 8201, 8111, 8005, 7884, 7749, 7599, 7436, 7261, 7073, 6875, 6667, 6452, 6229, 6001, 5769, 5535, 5300, 5067, 4835, 4608, 4386, 4171, 3964, 3767, 3580, 3405, 3243, 3094, 2960, 2840, 2735, 2645, 2571, 2512, 2468, 2438, 2422, 2420, 2431, 2453, 2485, 2527, 2578, 2635, 2699, 2766, 2836, 2908, 2980, 3051, 3119, 3183, 3242, 3294, 3339, 3375, 3402, 3418, 3424, 3418, 3400, 3371, 3329, 3275, 3209, 3131, 3042, 2942, 2832, 2713, 2586, 2451, 2310, 2164, 2014, 1861, 1706, 1552, 1399, 1248, 1101, 960, 824, 696, 576, 466, 365, 276, 199, 133, 81, 41, 14, 0, 0, 11, 36, 72, 119, 177, 245, 322, 406, 497, 593, 694, 797, 903, 1009, 1115, 1219, 1319, 1415, 1506, 1590, 1667, 1735, 1794, 1844, 1883, 1911, 1928, 1934, 1928, 1911, 1883, 1844, 1794, 1735, 1667, 1590, 1506, 1415, 1319, 1219, 1115, 1009, 903, 797, 694, 593, 497, 406, 322, 245, 177, 119, 72, 36, 11, 0, 0, 14, 41, 81, 133, 199, 276, 365, 466, 576, 696, 824, 960, 1101, 1248, 1399, 1552, 1706, 1861, 2014, 2164, 2310, 2451, 2586, 2713, 2832, 2942, 3042, 3131, 3209, 3275, 3329, 3371, 3400, 3418, 3424, 3418, 3402, 3375, 3339, 3294, 3242, 3183, 3119, 3051, 2980, 2908, 2836, 2766, 2699, 2635, 2578, 2527, 2485, 2453, 2431, 2420, 2422, 2438, 2468, 2512, 2571, 2645, 2735, 2840, 2960, 3094, 3243, 3405, 3580, 3767, 3964, 4171, 4386, 4608, 4835, 5067, 5300, 5535, 5769, 6001, 6229, 6452, 6667, 6875, 7073, 7261, 7436, 7599, 7749, 7884, 8005, 8111, 8201, 8276, 8337, 8383, 8414, 8433, 8439, 8433, 8417, 8393, 8361, 8323, 8281, 8236, 8191, 8147, 8107, 8072, 8043, 8024, 8015, 8019, 8036, 8070, 8121, 8190, 8278, 8387, 8518, 8670, 8844, 9041, 9260, 9502, 9765, 10048, 10352, 10675, 11015, 11371, 11742, 12125, 12518, 12920, 13329, 13741, 14155, 14568, 14978, 15382, 15778, 16165, 16539, 16898, 17241, 17566, 17871, 18155, 18417, 18655, 18870, 19061, 19227, 19370, 19489, 19585, 19660, 19715, 19751, 19771, 19777, 19772, 19758, 19739, 19717, 19697, 19681, 19674, 19680, 19702, 19744, 19810, 19905, 20031, 20194, 20396, 20641, 20931, 21272, 21663, 22110, 22612, 23173, 23793, 24474, 25215, 26018, 26881, 27804, 28786, 29825, 30918, 32064, 33258, 34498, 35779, 37097, 38448, 39826, 41226, 42641, 44068, 45498, 46926, 48345, 49749, 51130, 52484, 53802, 55078, 56306, 57481, 58594, 59642, 60619, 61518, 62337, 63070, 63713, 64263, 64718, 65074, 65329, 65483
};

// const static uint16_t* const wtables[] = {
//     wave_table_500,  wave_table_1000, wave_table_1500,
//     wave_table_2000, wave_table_2500, wave_table_3000,
//     wave_table_3500, wave_table_4000, wave_table_4500,
//     wave_table_5000, wave_table_5500, wave_table_6000,
//     wave_table_6500, wave_table_7000, wave_table_7500,
//     wave_table_8000
// };

#define min(a,b) ((a)<(b)?(a):(b))

static void isr() {
    static uint32_t idx = 0;
    idx += 2;
    uint16_t tab = ((generic_wave_table[(idx*2)&(tsizel2-1)])>>5);
    uint32_t noise = (generic_wave_table[idx&0xFF]&0xFFF)>>1;
    // tab += (generic_wave_table[idx++&(511)]>>4);
    DAC_out((((min((1<<12)-1, tab+noise))>>1))>>1);
}

void engine_sound_init() {
    Random_Init(0xF3339999);
    DAC_init();
}

// #define rpm_to_pd(rpm) (80000000/((uint32_t)((rpm<<3)+2000)))
#define rpm_to_pd(rpm) (80000000/((uint32_t)((rpm)+((rpm)>>2))))

void engine_sound_start(int32_t rpm) {
    Timer0A_Init(isr, rpm_to_pd(rpm), 0);
}

void engine_sound_up_rpm(int32_t rpm) {
    TIMER0_TAILR_R = rpm_to_pd(rpm);
}

void engine_sound_stop() {
    TIMER0_CTL_R = 0;
    DAC_out(0);
}

